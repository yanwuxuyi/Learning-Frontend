# 向量数据库功能说明

## 概述

本项目实现了旅游项目的向量化存储和智能搜索功能，支持对旅游项目进行增删改查操作，并同步维护向量数据库。

## 功能特性

### 1. 新增旅游项目 (`/api/add_course`)
- **方法**: POST
- **功能**: 将新的旅游项目信息向量化并存储到FAISS向量数据库
- **请求体**:
```json
{
    "name": "旅游项目名称",
    "description": "旅游项目描述",
    "destination": "目的地",
    "price": 2999.00
}
```
- **响应**:
```json
{
    "message": "课程添加成功",
    "id": 1234567890
}
```

### 2. 更新旅游项目 (`/api/update_course`)
- **方法**: PUT
- **功能**: 更新旅游项目信息，同时更新向量数据库中的对应向量
- **特殊处理**: 如果向量数据库中不存在该课程，会直接添加新记录
- **请求体**:
```json
{
    "id": 1234567890,
    "name": "更新后的旅游项目名称",
    "description": "更新后的旅游项目描述",
    "destination": "目的地",
    "price": 3999.00
}
```
- **响应** (存在时更新):
```json
{
    "message": "课程更新成功"
}
```
- **响应** (不存在时添加):
```json
{
    "message": "课程已添加到向量数据库"
}
```

### 3. 删除旅游项目 (`/api/delete_course`)
- **方法**: DELETE
- **功能**: 删除旅游项目，同时从向量数据库中删除对应向量
- **特殊处理**: 如果向量数据库中不存在该课程，会直接忽略删除操作
- **请求体**:
```json
{
    "id": 1234567890
}
```
- **响应** (存在时删除):
```json
{
    "message": "课程删除成功"
}
```
- **响应** (不存在时忽略):
```json
{
    "message": "课程在向量数据库不存在，已忽略删除操作"
}
```

### 4. 智能搜索 (`/api/search_courses`)
- **方法**: POST
- **功能**: 根据用户查询搜索相似的旅游项目
- **请求体**:
```json
{
    "query": "北京旅游项目"
}
```
- **响应**:
```json
{
    "context": "相关旅游项目信息如下：\n- 旅游项目: 北京故宫一日游. 简介: 包含故宫门票和导游服务.\n- 旅游项目: 北京长城半日游. 简介: 八达岭长城游览体验."
}
```

## 特殊处理逻辑

### 更新操作的特殊处理
当调用更新API时，系统会检查向量数据库中是否存在该课程：
- **存在**: 执行正常的更新操作，重建索引
- **不存在**: 直接添加新记录到向量数据库，返回201状态码

### 删除操作的特殊处理
当调用删除API时，系统会检查向量数据库中是否存在该课程：
- **存在**: 执行正常的删除操作，从向量数据库移除
- **不存在**: 直接忽略删除操作，返回200状态码和提示信息

## 技术实现

### 向量化技术
- 使用 **nomic-embed-text** 模型生成768维向量
- 通过本地Ollama服务进行向量化处理
- 向量化文本格式: `"旅游项目名称: {name}. 旅游安排: {description}. 目的地: {destination}. 价格: {price}元."`

### 存储技术
- **FAISS**: 用于高效的向量相似度搜索
- **JSON文件**: 存储课程数据和索引映射关系
- **索引映射**: 维护课程ID与向量索引的对应关系

### 数据结构
```
backend/
├── courses.faiss              # FAISS向量索引文件
├── courses.json               # 课程数据文件
├── course_index_mapping.json  # 课程ID与向量索引的映射文件
└── app.py                     # 主应用文件
```

## 前端集成

### API函数
在 `src/utils/api.js` 中提供了以下函数：

```javascript
// 添加课程到向量数据库
export function addCourseToVectorDB(courseData)

// 更新向量数据库中的课程
export function updateCourseInVectorDB(courseData)

// 从向量数据库中删除课程
export function deleteCourseFromVectorDB(courseId)
```

### 组件集成
- **Course-Form.vue**: 在更新课程时自动同步到向量数据库
- **Course-Manage.vue**: 在删除课程时自动从向量数据库删除
- **Course-Create.vue**: 在新增课程时自动添加到向量数据库

## 测试

运行测试脚本验证功能：

```bash
cd backend
python test_vector_db.py
```

测试脚本会依次执行：
1. 添加测试课程
2. 搜索验证添加结果
3. 更新课程信息
4. 搜索验证更新结果
5. 测试更新不存在的课程（应该直接添加）
6. 搜索验证不存在的课程是否被添加
7. 测试删除不存在的课程（应该忽略）
8. 删除课程
9. 搜索验证删除结果

## 数据修复

如果遇到数据错误（如KeyError: 'id'），可以运行数据修复脚本：

```bash
cd backend
python fix_data.py
```

修复脚本会：
1. 检查所有课程数据的有效性
2. 过滤掉无效数据（缺少id、name、description字段）
3. 重新生成向量索引
4. 重建索引映射关系
5. 保存修复后的数据

## 注意事项

1. **Ollama服务**: 确保本地Ollama服务正在运行，并安装了nomic-embed-text模型
2. **文件权限**: 确保应用有权限读写向量数据库文件
3. **数据一致性**: 向量数据库与主数据库需要保持同步
4. **性能考虑**: 大量数据时重建索引可能较慢，建议在低峰期进行批量操作
5. **容错处理**: 系统会自动处理向量数据库中不存在记录的情况

## 错误处理

- 向量化失败时会返回500错误
- 数据格式错误时会返回400错误
- 课程不存在时会根据操作类型进行特殊处理（更新时添加，删除时忽略）
- 所有错误都会在日志中记录详细信息

## 日志

系统会记录详细的操作日志，包括：
- 请求接收时间
- 向量化过程
- 索引操作
- 特殊处理逻辑（如不存在记录的处理）
- 错误信息

日志格式: `[YYYY-MM-DD HH:MM:SS] 消息内容`